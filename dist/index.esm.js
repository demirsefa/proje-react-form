import{useState as t,useCallback as e,useEffect as a,useInsertionEffect as r,useRef as s,createContext as i,useContext as n}from"react";var o,u,l;function c(t){return new Error(`"${t}" is not registered`)}!function(t){t.blur="blur",t.instant="instant"}(o||(o={})),function(t){t.YES="YES",t.AFTER_FIRST_SUBMIT_ATTEMPT="AFTER_FIRST_SUBMIT_ATTEMPT",t.NO="NO"}(u||(u={})),o.instant,function(t){t.INIT="INIT",t.NEW_VALUE="NEW_VALUE",t.BLURRED="BLURRED",t.ASYNC_VALIDATION="ASYNC_VALIDATION",t.SUBMIT_STARTED="SUBMIT_STARTED",t.SUBMIT_ERROR="SUBMIT_ERROR",t.SUBMIT_SUCCEED="SUBMIT_SUCCEED",t.NEW_VALUE_DEBOUNCED="NEW_VALUE_DEBOUNCED",t.BLURRED_DEBOUNCED="BLURRED_DEBOUNCED"}(l||(l={}));class d{time;__select_time;constructor(t=800){this.time=t,this.__select_time=0}cb(t){this.reset(),this.__select_time=setTimeout((()=>{t&&t()}),this.time)}reset(){clearTimeout(this.__select_time)}}function h(t,e){function a(e){e.error?t.formState.formStatus="ERROR":"ERROR"!==t.formState.formStatus?t.formState.formStatus="NOT-CLEAN":t.formState.formStatus=Object.values(t.inputStates).reduce(((t,e)=>t&&!!e.error),!1)?"ERROR":"NOT-CLEAN"}switch(e.type){case l.INIT:t.formState.formStatus="CLEAN";break;case l.BLURRED_DEBOUNCED:case l.NEW_VALUE_DEBOUNCED:{const r=e.payload,s=r.error,i=r.validateRequired,n=t.inputStates[r.name];if(!n)throw c(r.name);if(n.value=n._refreshValue,s&&!Array.isArray(s))throw new Error("error must be array");n.error=s,n.validateRequired=i??n.validateRequired,a(n);break}case l.NEW_VALUE:{const r=e.payload,s=r.value,i=r.error,n=r.validateRequired,u=t.inputStates[r.name];if(!u)throw c(r.name);if(u._refreshValue=s,t.formState.refreshType===o.instant&&(t.formState.debounceNumber&&0!==t.formState.debounceNumber||(u.value=s)),i&&!Array.isArray(i))throw new Error("error must be array");u.error=i,u.validateRequired=n??u.validateRequired,a(u);break}case l.BLURRED:{if(t.formState.refreshType!==o.blur)break;const r=e.payload,s=r.error,i=r.validateRequired,n=t.inputStates[r.name];if(!n)throw c(r.name);if(n.value=n._refreshValue,s&&!Array.isArray(s))throw new Error("error must be array");n.error=s,n.validateRequired=i??n.validateRequired,a(n);break}case l.SUBMIT_STARTED:{const a=e.payload;t.formState.loading=!0,t.formState.confirmActive=a.confirmActive,t.formState.submitAttemptNumber++;break}case l.SUBMIT_SUCCEED:t.formState.confirmActive=!1,t.formState.loading=!1,Object.values(t.inputStates).forEach((t=>{t.validateRequired=!1})),t.formState.formStatus="SUCCESS";break;case l.SUBMIT_ERROR:{const a=e.payload;t.formState.confirmActive=!1,t.formState.loading=!1,Object.values(t.inputStates).forEach((t=>{t.validateRequired=!1})),t.formState.formStatus="ERROR";const r=a.error;if(r)if(Array.isArray(r))r.forEach((e=>{if(e instanceof Error||!e.name)t.formState.error=e;else{const a=t.inputStates[e.name];a&&(a.error=Array.isArray(e)?e:[e])}}));else if(console.error(r),r instanceof Error||!r.name)t.formState.error=r;else{const e=t.inputStates[r.name];e&&(e.error=[r])}else console.warn("Wrong usage, error must be filled if success is false");break}case l.ASYNC_VALIDATION:{const a=e.payload,r=t.inputStates[a.name];if(!r)throw c(a.name);a.forSubmit&&(t.formState.loading=a.value),r.validateLoading=a.value;break}default:throw new Error("Unexpected Action Type")}return t}class m{state;reducer;listeners=[];instantListeners=[];debounce;__inputValidationFunctions__={};__lastEvent__={actionProps:{type:l.INIT,payload:void 0},index:0};constructor(t,e){this.state=t,this.reducer=e,this.debounce=t.formState.debounceNumber&&t.formState.debounceNumber>0?new d(t.formState.debounceNumber):void 0}subscribe(t){return this.listeners.push(t),()=>{this.listeners.splice(this.listeners.indexOf(t),1)}}subscribeInstant(t){return this.instantListeners.push(t),()=>{this.listeners.splice(this.instantListeners.indexOf(t),1)}}dispatch(t){this.__lastEvent__={actionProps:{type:t.type,payload:t.payload},index:this.__lastEvent__.index+1},(t.type===l.NEW_VALUE&&this.state.formState.refreshType===o.instant||t.type===l.BLURRED&&this.state.formState.refreshType===o.blur)&&this.state.formState.debounceNumber&&this.state.formState.debounceNumber>0?(console.log("debounce",t,this.state.formState.refreshType),this.debounce?.cb((()=>{t.type===l.BLURRED?this.dispatch({type:l.NEW_VALUE_DEBOUNCED,payload:t.payload}):this.dispatch({type:l.BLURRED_DEBOUNCED,payload:t.payload})}))):(this.state=this.reducer(this.state,t),this.instantBroadcast(),this.broadcast())}getValidationData(){return Object.entries(this.state.inputStates).filter((([,t])=>t.validateRequired)).reduce(((t,[e,a])=>(t[e]=a.value,t)),{})}createInput(t,e){if(this.state.inputStates[t])return this.state.inputStates[t];this.state.inputStates[t]={name:t,value:e.defaultValue,validateLoading:!1,_refreshValue:e.defaultValue,validateRequired:!0,error:void 0}}broadcast(){this.listeners.forEach((t=>t(this.state)))}instantBroadcast(){this.instantListeners.forEach((t=>t(this.state)))}getRawData(){return Object.entries(this.state.inputStates).reduce(((t,[e,a])=>(t[e]=a.value,t)),{})}getShouldValidateAgain(){return Object.values(this.state.inputStates).reduce(((t,e)=>t||e.validateRequired),!1)}addValidation(t,e){this.__inputValidationFunctions__[t]=e||void 0}}const f=/^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/im,p=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,S=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&/=]*)/;function v(t){return!!t}function y(t,e){if(!t)return!0;let a=Number(t);return!isNaN(a)&&a>e}function _(t,e){return!t||"string"==typeof t&&t.length>e}function E(t,e){if(!t)return!0;let a=Number(t);return!isNaN(a)&&a<e}function b(t,e){return!t||"string"==typeof t&&t.length<e}function g(t){return!t||"string"==typeof t&&!!t.toLowerCase().match(p)}function R(t){return!t||"string"==typeof t&&!!t.match(f)}function A(t,e){return!e||t===e}function T(t){return!t||"string"==typeof t&&!!t.match(S)}function N(t,e){return!t||"string"==typeof t&&e.test(t)}var V;!function(t){t.required="required",t.min="min",t.minLength="minLength",t.max="max",t.maxLength="maxLength",t.email="email",t.phone="phone",t.repeatPassword="repeatPassword",t.url="url",t.regex="regex"}(V||(V={}));class I{store;validateName;validations={};settings={validateAll:!1};constructor(t,e){this.store=t,this.validateName=e}required(){return this.register(V.required,v)}min(t){return this.register(V.min,y,t)}minLength(t){return this.register(V.minLength,_,t)}max(t){return this.register(V.max,E,t)}maxLength(t){return this.register(V.maxLength,b,t)}email(){return this.register(V.email,g)}phone(){return this.register(V.phone,R)}repeatPassword(t){const e=this.store.getRawData();return this.register(V.repeatPassword,A,e?e[t]:void 0)}url(){return this.register(V.url,T)}regex(t){return this.register(V.regex,N,t)}validate(t,e,a){return this.register("custom_"+this.validateName,e,Number(a))}async(t,e,a){return this.registerAsync(t,e,a)}set(t){return this.settings={...this.settings,validateAll:t.validateAll},this}register(t,e,a){return this.validations[t]={fn:e,payload:a,async:!1},this}registerAsync(t,e,a){return this.validations[t]={fn:e,payload:a,async:!0},this}}function L(t){switch(console.log("error",t),t.type){case V.required:return"This Field is required.";case V.min:return"Minimum required number is "+t.payload;case V.minLength:return"Minimum "+t.payload+" "+(1===t.payload?"character":"characters")+" are allowed";case V.max:return"Maximum required number is "+t.payload;case V.maxLength:return"Maximum "+t.payload+" "+(1===t.payload?"character":"characters")+" are allowed";case V.email:return"Please enter a valid email address.";case V.phone:return"Please enter a valid phone number.";case V.repeatPassword:return(t&&t.name?t.name:"Password ")+" is not matched.";case V.url:return"Please enter a valid url."}return t.payload?.message||"Invalid field"}class U{confirm=null;store;constructor({refreshType:t=o.blur,shouldValidate:e=u.AFTER_FIRST_SUBMIT_ATTEMPT,debounceNumber:a}){this.store=new m({formState:{formStatus:"CLEAN",confirmActive:!1,error:null,loading:!1,debounceNumber:a,refreshType:t,shouldValidate:e,submitAttemptNumber:0},inputStates:{}},h),this.onSubmit=this.onSubmit.bind(this)}getDataWithoutValidation(){const t=this.store.getRawData();return{isValid:void 0,validateErrors:void 0,shouldValidateAgain:this.store.getShouldValidateAgain(),loading:this.store.state.formState.loading,data:t}}async getDataWithValidation(t,{validateLoading:e}){const a=this.store.getRawData(),r={isValid:void 0,validateErrors:void 0,shouldValidateAgain:this.store.getShouldValidateAgain(),loading:this.store.state.formState.loading,data:a};if(t){const t=await this.validate(a,{validateLoading:e});r.isValid=!(t&&t.length),r.validateErrors=t}return r}async onSubmit(t){const e=this.store.state,a=e.formState;Object.values(e.inputStates).forEach((t=>{t.value=t._refreshValue})),a.loading&&console.warn("Double click detect"),a.confirmActive&&console.warn("Form submitted when confirm active"),this.store.dispatch({type:l.SUBMIT_STARTED,payload:{confirmActive:!0}});const r=await this.getDataWithValidation(!0,{validateLoading:!0});if(r.isValid)try{const e=t=>{this.confirm=(e,a)=>{if(e){const e=t(a);this.onSubmitResult(e)}else this.store.dispatch({type:l.SUBMIT_ERROR,payload:{payload:{error:a}}})}},s=t&&t(r,{confirm:e});if(a.confirmActive)return;this.onSubmitResult(s)}catch(t){this.store.dispatch({type:l.SUBMIT_ERROR,payload:{payload:{error:t}}})}else{const t=[];if(r.validateErrors){for(let e=0;e<r.validateErrors.length;e++){const a=r.validateErrors[e];t.push({value:a.value,name:a.name,payload:a.payload,type:a.type})}this.store.dispatch({type:l.SUBMIT_ERROR,payload:{error:t}})}}}shouldValidate(t){const e=this.store.state.formState.shouldValidate;let a=!1;if("function"==typeof e)a=e(this);else{const r=e;(r===u.YES||r===u.AFTER_FIRST_SUBMIT_ATTEMPT&&t.submitAttemptNumber>0)&&(a=!0)}return a}createInput(t,e){return this.store.createInput(t,e),e.validation?this.store.__inputValidationFunctions__[t]=e.validation:this.store.__inputValidationFunctions__[t]=void 0,{onChange:e=>{this.setValue(t,e).then()},onBlur:async()=>{console.log("this.store.state.formState.refreshType",this.store.state.formState.refreshType),this.store.state.formState.refreshType===o.blur&&setTimeout((async()=>{let e;const a=this.store.state.inputStates[t],r=a?._refreshValue;a?.validateRequired&&(e=await this.validateInput(t,r)),this.store.dispatch({type:l.BLURRED,payload:{name:t,error:e,validateRequired:void 0===e}})}),50)},addValidation:e=>{this.store.addValidation(t,e)}}}deleteInput(t){this.checkNameExist(t),delete this.store.state.inputStates[t]}async setValue(t,e){this.checkNameExist(t);let a=null,r=!1;this.store.state.formState.refreshType===o.instant&&(a=await this.validateInput(t,e),r=!0),this.store.dispatch({type:l.NEW_VALUE,payload:{value:e,name:t,error:a,validateRequired:!r}})}async validateInput(t,e){this.checkNameExist(t);const a=this.store.state.formState,r=this.store.__inputValidationFunctions__[t];if(!r)return null;if(!this.shouldValidate(a))return;const s=r(new I(this.store,"validator_"+t));if(!s)return null;let i=[];const n=Object.keys(s.validations);for(let a=0;a<n.length;a++){if(i.length&&!s.settings.validateAll)return i;const r=n[a],o=s.validations[r],u=o.fn(e,o.payload);if(u||i.push([{name:t,type:r,value:e,payload:o.payload}]),u&&u.then){this.store.dispatch({type:l.ASYNC_VALIDATION,payload:{name:t,value:!0,forSubmit:!1}});const a=await u;this.store.dispatch({type:l.ASYNC_VALIDATION,payload:{name:t,value:!1,forSubmit:!1}}),a||i.push({name:t,type:r,value:e,payload:o.payload})}}return i}async validate(t,{validateLoading:e}){const a=[],r=Object.keys(t);for(let s=0;s<r.length;s++){const i=r[s],n=this.store.__inputValidationFunctions__[i];if(!n)continue;const o=n(new I(this.store,"validator_"+i));if(!o)continue;const u=Object.keys(o.validations);for(let r=0;r<u.length;r++){const s=u[r],n=o.validations[s],c=t[i],d=n.fn(c,n.payload);if(d||a.push({name:i,type:s,value:c,payload:n.payload}),d&&d.then){e&&this.store.dispatch({type:l.ASYNC_VALIDATION,payload:{name:i,value:!0,forSubmit:!0}});const t=await d;e&&this.store.dispatch({type:l.ASYNC_VALIDATION,payload:{name:i,value:!1,forSubmit:!0}}),t||a.push({name:i,type:s,value:c,payload:n.payload})}}}return a}checkNameExist(t){if(!this.store.state.inputStates[t])throw c(t)}onSubmitResult(t){if(t&&void 0!==t.then){t.then((()=>{this.store.dispatch({type:l.SUBMIT_SUCCEED})})).catch((t=>{this.store.dispatch({type:l.SUBMIT_ERROR,payload:{error:t}})}))}else this.store.dispatch({type:l.SUBMIT_SUCCEED})}}function D(r){const[s,i]=t((()=>r.store.state.formState.confirmActive)),n=e((t=>{r.confirm&&r.confirm(!0,t)}),[r]),o=e((()=>{r.confirm&&r.confirm(!1)}),[r]);return a((()=>r.store.subscribe((t=>{i(r.store.state.formState.confirmActive)}))),[r]),{active:s,resolve:n,reject:o}}function w(t,e,a={}){const s=t.createInput(e,{defaultValue:a.defaultValue,validation:a.validation});return r((()=>()=>t.deleteInput(e)),[t,e]),s}function B(e){const[r,s]=t((()=>e.store.state.formState?.error));return a((()=>{s(e.store.state.formState?.error)}),[e]),a((()=>e.store.subscribe((()=>{const t=e.store.state.formState;s(t?.error)}))),[e]),r}function O(e,r){const[s,i]=t((()=>e.store.state.inputStates[r]?.error)),[n,o]=t((()=>e.store.state.inputStates[r]?.validateLoading));return a((()=>{const t=e.store.state.inputStates[r];i(t?.error),o(t?.validateLoading)}),[e,r]),a((()=>e.store.subscribe((()=>{const t=e.store.state.inputStates[r];i(t?.error),o(t?.validateLoading)}))),[e,r]),{error:s&&s[0],loading:n}}function C(e){const[r,s]=t((()=>[{...e.store.__lastEvent__}]));return a((()=>e.store.subscribe((()=>{const t=e.store.__lastEvent__;s((e=>[...e,{...t}]))}))),[e]),[r,s]}function x(e){const[r,s]=t((()=>e.store.state.formState?.loading));return a((()=>{s(e.store.state.formState?.loading)}),[e]),a((()=>e.store.subscribe((t=>{s(t.formState.loading)}))),[e]),r}function M(e){const[r,i]=t((()=>e.getDataWithoutValidation())),n=s(0);return a((()=>{const t=e.store;return t.subscribe((async()=>{const a=t.state.formState;if("NOT-CLEAN"!==a.formStatus)return;const r=a.submitAttemptNumber,s=await e.getDataWithValidation(n.current!==r,{validateLoading:!1});n.current!==r&&(n.current=r),i(s)}))}),[e]),r}function q(e,r){const[s,i]=t((()=>e.store.state));return a((()=>{const t=t=>{i({...t})};return"instant"===r?e.store.subscribeInstant(t):e.store.subscribe(t)}),[r,e]),s}function F(e,r){const[s,i]=t((()=>r?e.store.state.inputStates[r]?.value:void 0));return a((()=>{r&&i(e.store.state.inputStates[r]?.value)}),[e,r]),a((()=>{if(!r)return;return e.store.subscribe((t=>{i(t.inputStates[r]?.value)}))}),[e,r]),s}function k(e,r){const[s,i]=t((()=>r?e.store.state.inputStates[r]?._refreshValue:void 0));return a((()=>{r&&i(e.store.state.inputStates[r]?._refreshValue)}),[e,r]),a((()=>{if(!r)return;return e.store.subscribeInstant((t=>{i(t.inputStates[r]?._refreshValue)}))}),[e,r]),s}const P=i(null);function W(){const t=n(P);if(!t)throw new Error(`You cannot use ${"useContextFormBase"} outside of Form Component`);return t.formBase}export{l as ActionType,U as FormBase,o as FormRefreshType,u as FormShouldValidateType,I as Validator,L as getErrorDefaultText,D as useConfirm,W as useContextFormBase,w as useCreateInput,B as useErrorForGlobal,O as useErrorForInput,C as useEventChange,k as useInstantWatch,x as useLoading,M as useResponseDataWatch,q as useStoreStateWatch,F as useWatch};
//# sourceMappingURL=index.esm.js.map
