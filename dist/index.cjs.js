"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r,a,n=t(e);function s(e){return new Error(`"${e}" is not registered`)}exports.FormRefreshType=void 0,(r=exports.FormRefreshType||(exports.FormRefreshType={}))[r.blur=0]="blur",r[r.instant=1]="instant",exports.FormRefreshType.instant,exports.FormRefreshType.instant,function(e){e.INIT="INIT",e.NEW_VALUE="NEW_VALUE",e.BLURRED="BLURRED",e.NEW_FORCED_VALUE="NEW_FORCED_VALUE",e.SET_INPUT_ERROR="SET_INPUT_ERROR",e.CLEAN_INPUT_ERROR="CLEAN_INPUT_ERROR",e.SET_LOADING_ON="SET_LOADING_ON",e.SET_LOADING_OFF="SET_LOADING_OFF",e.SET_GLOBAL_ERROR="SET_GLOBAL_ERROR",e.CLEAR_GLOBAL_ERROR="CLEAR_GLOBAL_ERROR",e.SET_SUCCESS="SET_SUCCESS",e.ASYNC_VALIDATION="ASYNC_VALIDATION"}(a||(a={}));class o{time;__select_time;constructor(e=800){this.time=e,this.__select_time=0}cb(e){this.reset(),this.__select_time=setTimeout((()=>{e&&e()}),this.time)}reset(){clearTimeout(this.__select_time)}}function i(e,t){switch(t.type){case a.SET_LOADING_ON:e.formState.loading=!0;break;case a.SET_LOADING_OFF:e.formState.loading=!1;break;case a.CLEAR_GLOBAL_ERROR:e.formState.formStatus="CLEAN",e.formState.error=null;break;case a.SET_GLOBAL_ERROR:e.formState.formStatus="GLOBAL-ERROR",e.formState.formAttemptGlobalError++,e.formState.error=t.payload;break;case a.CLEAN_INPUT_ERROR:e.inputStates[t.payload.name].error=null,"GLOBAL-ERROR"!==e.formState.formStatus&&Object.values(e.inputStates).reduce(((e,t)=>e&&t))&&(e.formState.formStatus="CLEAN");break;case a.SET_INPUT_ERROR:if(t.payload.name){const r=e.inputStates[t.payload.name];r.error=t.payload,r.validateLoading=!1}break;case a.NEW_FORCED_VALUE:{const r=t.payload,a=r.value,n=e.inputStates[r.name];if(!n)throw s(r.name);n.value=a;break}case a.NEW_VALUE:{e.formState.formStatus="DIRTY";const r=t.payload,a=r.value,n=e.inputStates[r.name];if(!n)throw s(r.name);n.value!==a&&(n._refreshValue=a,e.formState.refreshType===exports.FormRefreshType.instant&&(e.formState.debounceNumber&&0!==e.formState.debounceNumber||(n.value=a)));break}case a.BLURRED:{const r=t.payload,a=e.inputStates[r.name];if(!a)throw s(r.name);a.value=a._refreshValue;break}case a.SET_SUCCESS:e.formState.formStatus="SUCCESS";break;case a.ASYNC_VALIDATION:if(t.payload.name){e.inputStates[t.payload.name].validateLoading=t.payload.value}break;default:throw new Error("Unexpected Action Type")}return e}class u{state;reducer;listeners=[];debounce;lastEvent={actionType:a.INIT,index:0};constructor(e,t){this.state=e,this.reducer=t,this.debounce=new o(e.formState.debounceNumber)}subscribe(e){return this.listeners.push(e),()=>{this.listeners.splice(this.listeners.indexOf(e),1)}}dispatch(e){this.lastEvent={actionType:e.type,index:this.lastEvent.index+1},this.state=this.reducer(this.state,e),e.type===a.NEW_VALUE&&this.state.formState.debounceNumber&&this.state.formState.debounceNumber>0?this.debounce?.cb((()=>{this.dispatch({type:a.NEW_FORCED_VALUE,payload:e.payload})})):this.broadcast()}getData(){let e={};const t=Object.keys(this.state.inputStates);for(let r=0;r<t.length;r++){const a=this.state.inputStates[t[r]];e[a.name]=a.value}return e}getValidationData(){let e={};const t=Object.keys(this.state.inputStates);for(let r=0;r<t.length;r++){const a=this.state.inputStates[t[r]];a.validateRequired&&(e[a.name]=a.value)}return e}checkInputExist(e){return!!this.state.inputStates[e]}getInputState(e){return this.state.inputStates[e]}createInput(e,t){return this.state.inputStates[e]={name:e,value:t.defaultValue,fragmentId:t.fragmentId,validateLoading:!1,_refreshValue:t.defaultValue,blurNumber:0,validateRequired:!1,validation:t.validation,error:null}}deleteInput(e){if(!this.state.inputStates[e])throw s(e);delete this.state.inputStates[e]}getFormState(){return this.state.formState}broadcast(){this.listeners.forEach((e=>e(this.state)))}getState(){return this.state}getDataByFragment(e){let t={};const r=Object.keys(this.state.inputStates);for(let a=0;a<r.length;a++){const n=this.state.inputStates[r[a]];n.fragmentId===e&&(t[n.name]=n.value)}return t}}const l=/^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/im,c=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,d=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&/=]*)/;function m(e){return!!e}function p(e,t){let r=Number(e);return!isNaN(r)&&r>t}function h(e,t){return"string"==typeof e&&e.length>t}function f(e,t){let r=Number(e);return!isNaN(r)&&r<t}function S(e,t){return"string"==typeof e&&e.length<t}function g(e){return"string"==typeof e&&!!e.toLowerCase().match(c)}function E(e){return"string"==typeof e&&!!e.match(l)}function y(e,t){return e===t}function _(e){return"string"==typeof e&&!!e.match(d)}function R(e,t){return"string"==typeof e&&t.test(e)}var v;!function(e){e.required="required",e.min="min",e.minLength="minLength",e.max="max",e.maxLength="maxLength",e.email="email",e.phone="phone",e.repeatPassword="repeatPassword",e.url="url",e.regex="regex"}(v||(v={}));class b{store;validateName;validations={};constructor(e,t){this.store=e,this.validateName=t}required(){return this.register(v.required,m)}min(e){return this.register(v.min,p,e)}minLength(e){return this.register(v.minLength,h,e)}max(e){return this.register(v.max,f,e)}maxLength(e){return this.register(v.maxLength,S,e)}email(){return this.register(v.email,g)}phone(){return this.register(v.phone,E)}repeatPassword(e){const t=this.store.getData();return this.register(v.repeatPassword,y,t?t[e]:void 0)}url(){return this.register(v.url,_)}regex(e){return this.register(v.regex,R,e)}register(e,t,r){return this.validations[e]={fn:t,payload:r},this}registerAsync(e,t,r){return this.validations[e]={fn:t,payload:r},this}validate(e,t,r){return this.register("custom_"+this.validateName,t,Number(r))}async(e,t,r){return this.registerAsync("custom_"+this.validateName,t,Number(r))}}class L{store;confirmRequired=null;confirmPause=!1;fragmentNumber=0;constructor({refreshType:e=exports.FormRefreshType.blur}){this.store=new u({formState:{formStatus:"CLEAN",formAttemptGlobalError:0,formAttemptError:0,error:null,readyToSubmit:!1,confirmed:!1,loading:!1,debounceNumber:0,refreshType:e},inputStates:{}},i),this.onSubmit=this.onSubmit.bind(this)}getStore(){return this.store}onSubmit(e){if(this.confirmPause)return;const t=this.store.getData(),r=this.validate(t);if(this.store.getFormState().loading&&console.warn("Double click detect"),r)for(let e=0;e<r.length;e++){const t=r[e];this.store.dispatch({type:a.SET_INPUT_ERROR,payload:{value:t.value,name:t.name,payload:t.payload,type:t.type}})}else try{this.store.dispatch({type:a.CLEAR_GLOBAL_ERROR});const r=e(t,{confirm:e=>{this.confirmRequired=e,this.confirmPause=!0,this.store.broadcast()}});if(r&&void 0!==r.then){this.store.dispatch({type:a.SET_LOADING_ON});r.catch((e=>{this.store.dispatch({type:a.SET_GLOBAL_ERROR,payload:e})})).then((()=>{this.store.dispatch({type:a.SET_SUCCESS})})).finally((()=>{this.store.dispatch({type:a.SET_LOADING_OFF})}))}}catch(e){this.store.dispatch({type:a.SET_GLOBAL_ERROR,payload:{type:"global",payload:e}})}}createInput(e,t){const r=this.store.createInput(e,t),n=this.store.getFormState();return{onChange:async t=>{if(this.store.dispatch({type:a.NEW_VALUE,payload:{value:t,name:e}}),n.refreshType===exports.FormRefreshType.instant){const a=await this.validateInput(e,t);this.dispatchError(t,r,a)}},onBlur:async()=>{if(this.store.dispatch({type:a.BLURRED,payload:{name:e}}),n.refreshType===exports.FormRefreshType.blur){const t=this.store.getInputState(e)?.value,a=await this.validateInput(e,t);this.dispatchError(t,r,a)}}}}deleteInput(e){this.store.deleteInput(e)}async validateInput(e,t){const r=this.store.getInputState(e);if(!r||!r?.validation)return null;const n=(0,r.validation)(new b(this.store,"validator_"+e)),s=Object.keys(n.validations);for(let o=0;o<s.length;o++){const i=s[o],u=n.validations[i],l=u.fn(t,u.payload);if(!l)return{name:e,type:i,value:t,payload:u.payload};if(l&&l.then){this.store.dispatch({type:a.ASYNC_VALIDATION,payload:{name:r.name,value:!0}});if(!await l)return{name:e,type:i,value:t,payload:u.payload}}}}validateFragment(e,t){const r=this.store.getDataByFragment(e),n=this.validate(r);if(n&&0!==n.length)for(let e=0;e<n.length;e++){const t=n[e];this.store.dispatch({type:a.SET_INPUT_ERROR,payload:{value:t.value,name:t.name,payload:t.payload,type:t.type}})}else t&&t()}validate(e){const t=[],r=Object.keys(e);for(let a=0;a<r.length;a++){const n=r[a],s=this.store.getInputState(n);if(!s||!s?.validation)continue;const o=s?.validation,i=o(new b(this.store,"validator_"+n)),u=Object.keys(i.validations);for(let r=0;r<u.length;r++){const a=u[r],s=i.validations[a];if(!s.fn(e[n],s.payload)){t.push({name:n,type:a,value:e[n],payload:s.payload});break}}}return t}dispatchError(e,t,r){r?this.store.dispatch({type:a.SET_INPUT_ERROR,payload:{value:e,name:t.name,payload:r.payload,type:r.type}}):t.error&&!r&&this.store.dispatch({type:a.CLEAN_INPUT_ERROR,payload:{value:e,name:t.name}}),t.validateLoading&&this.store.dispatch({type:a.ASYNC_VALIDATION,payload:{name:t.name,value:!1}})}getData(){return this.getStore().getData()}confirm(e){this.confirmPause=!1,this.confirmRequired&&this.confirmRequired(e),this.store.broadcast()}confirmCancel(){this.confirmPause=!1,this.confirmRequired=null,this.store.broadcast()}getFragmentNumber(){const e=this.fragmentNumber;return this.fragmentNumber++,e}}function N(t,r){const[a,n]=e.useState((()=>t.getStore().getInputState(r)?.error)),[s,o]=e.useState((()=>t.getStore().getInputState(r)?.validateLoading));return e.useEffect((()=>{const e=t.getStore().getInputState(r);n(e?.error),o(e?.validateLoading)}),[t,r]),e.useEffect((()=>t.getStore().subscribe((()=>{const e=t.getStore().getInputState(r);n(e?.error),o(e?.validateLoading)}))),[t,r]),{error:a,loading:s}}function I(t){const[r,a]=e.useState((()=>t.getStore().getFormState()?.error));return e.useEffect((()=>{a(t.getStore().getFormState()?.error)}),[t]),e.useEffect((()=>t.getStore().subscribe((()=>{const e=t.getStore().getFormState();a(e?.error)}))),[t]),r}function T(t){const[r,a]=e.useState((()=>t.getStore().getFormState()?.loading));return e.useEffect((()=>{a(t.getStore().getFormState()?.loading)}),[t]),e.useEffect((()=>t.getStore().subscribe((e=>{a(e.formState.loading)}))),[t]),r}function O(t,r,a){const n=e.useMemo((()=>t.createInput(r,{defaultValue:a.defaultValue,validation:a.validation,fragmentId:a.fragmentId})),[t,a.defaultValue,a.validation,a.fragmentId]);return e.useInsertionEffect((()=>()=>t.deleteInput(r)),[t,r]),n}const A=e.createContext(null);function x(t){const r=e.useMemo((()=>t.formBase?t.formBase:new L({refreshType:t.refreshType})),[]);return n.default.createElement(A.Provider,{value:{formBase:r}},t.children)}function C(){const t=e.useContext(A);if(!t)throw new Error(`You cannot use ${"useContextFormBase"} outside of Form Component`);return t.formBase}function F(e){const t=C(),r=T(t);return n.default.createElement("form",{...e,onSubmit:a=>{a.preventDefault(),r||t.onSubmit(e.onSubmit)}})}const w=e.createContext(null);function B(){const t=e.useContext(w);return t?t.id:null}exports.ErrorForGlobal=function({errorMessage:e="Something went wrong"}){return I(C())?n.default.createElement("p",null,e):null},exports.ErrorForInput=function({name:e}){const t=C(),{error:r,loading:a}=N(t,e);return n.default.createElement("p",null,r?function(e){switch(e.type){case v.required:return"This Field is required.";case v.min:return"Minimum required number is "+e.payload;case v.minLength:return"Minimum "+e.payload+" "+(1===e.payload?"character":"characters")+" are allowed";case v.max:return"Maximum required number is "+e.payload;case v.maxLength:return"Maximum "+e.payload+" "+(1===e.payload?"character":"characters")+" are allowed";case v.email:return"Please enter a valid email address.";case v.phone:return"Please enter a valid phone number.";case v.repeatPassword:return(e&&e.name?e.name:"Password ")+" is not matched.";case v.url:return"Please enter a valid url."}return e.payload?.message||"Invalid field"}(r):null,a?n.default.createElement("span",null,"Loading"):null)},exports.Form=function(e){const{refreshType:t,formBase:r,...a}=e;return n.default.createElement(x,{formBase:r,refreshType:t},n.default.createElement(F,{...a},e.children))},exports.Input=function(e){const{name:t,validation:r,defaultValue:a,...s}=e,o=C(),i=B(),{onChange:u,onBlur:l}=O(o,t,{defaultValue:a,fragmentId:i,validation:r});return n.default.createElement("input",{...s,name:t,onChange:e=>{const t=e.target.value;u(t),s.onChange&&s.onChange(e)},onBlur:e=>{l(),s.onBlur&&s.onBlur(e)}})},exports.Textarea=function(t){const{name:r,defaultValue:a,validation:s,...o}=t,i=C(),u=B(),{onChange:l,onBlur:c}=O(i,r,{defaultValue:a,fragmentId:u,validation:s});return e.useInsertionEffect((()=>()=>i.deleteInput(r)),[i,r]),n.default.createElement("textarea",{...o,name:r,onChange:e=>{const t=e.target.value;l(t),o.onChange&&o.onChange(e)},onBlur:e=>{c(),o.onBlur&&o.onBlur(e)}})},exports.useErrorForGlobal=I,exports.useErrorForInput=N,exports.useInput=O,exports.useLoading=T,exports.useStoreStateWatch=function(t){const[r,a]=e.useState((()=>t.getStore().getState()));return e.useEffect((()=>t.getStore().subscribe((e=>{a({...e})}))),[t]),r},exports.useWatch=function(t,r){const[a,n]=e.useState((()=>t.getStore().getInputState(r)?.value));return e.useEffect((()=>{n(t.getStore().getInputState(r)?.value)}),[t,r]),e.useEffect((()=>t.getStore().subscribe((e=>{n(e.inputStates[r]?.value)}))),[t,r]),a};
//# sourceMappingURL=index.cjs.js.map
