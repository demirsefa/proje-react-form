"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e,r,a=require("react");function s(t){return new Error(`"${t}" is not registered`)}exports.FormRefreshType=void 0,(t=exports.FormRefreshType||(exports.FormRefreshType={})).blur="blur",t.instant="instant",exports.FormShouldValidateType=void 0,(e=exports.FormShouldValidateType||(exports.FormShouldValidateType={})).YES="YES",e.AFTER_FIRST_SUBMIT_ATTEMPT="AFTER_FIRST_SUBMIT_ATTEMPT",e.NO="NO",exports.FormRefreshType.instant,exports.ActionType=void 0,(r=exports.ActionType||(exports.ActionType={})).INIT="INIT",r.NEW_VALUE="NEW_VALUE",r.BLURRED="BLURRED",r.ASYNC_VALIDATION="ASYNC_VALIDATION",r.SUBMIT_STARTED="SUBMIT_STARTED",r.SUBMIT_ERROR="SUBMIT_ERROR",r.SUBMIT_SUCCEED="SUBMIT_SUCCEED",r.NEW_VALUE_DEBOUNCED="NEW_VALUE_DEBOUNCED",r.BLURRED_DEBOUNCED="BLURRED_DEBOUNCED";class i{time;__select_time;constructor(t=800){this.time=t,this.__select_time=0}cb(t){this.reset(),this.__select_time=setTimeout((()=>{t&&t()}),this.time)}reset(){clearTimeout(this.__select_time)}}function o(t,e){function r(e){e.error?t.formState.formStatus="ERROR":"ERROR"!==t.formState.formStatus?t.formState.formStatus="NOT-CLEAN":t.formState.formStatus=Object.values(t.inputStates).reduce(((t,e)=>t&&!!e.error),!1)?"ERROR":"NOT-CLEAN"}switch(e.type){case exports.ActionType.INIT:t.formState.formStatus="CLEAN";break;case exports.ActionType.BLURRED_DEBOUNCED:case exports.ActionType.NEW_VALUE_DEBOUNCED:{const a=e.payload,i=a.error,o=a.validateRequired,n=t.inputStates[a.name];if(!n)throw s(a.name);if(n.value=n._refreshValue,i&&!Array.isArray(i))throw new Error("error must be array");n.error=i,n.validateRequired=o??n.validateRequired,r(n);break}case exports.ActionType.NEW_VALUE:{const a=e.payload,i=a.value,o=a.error,n=a.validateRequired,u=t.inputStates[a.name];if(!u)throw s(a.name);if(u._refreshValue=i,t.formState.refreshType===exports.FormRefreshType.instant&&(t.formState.debounceNumber&&0!==t.formState.debounceNumber||(u.value=i)),o&&!Array.isArray(o))throw new Error("error must be array");u.error=o,u.validateRequired=n??u.validateRequired,r(u);break}case exports.ActionType.BLURRED:{if(t.formState.refreshType!==exports.FormRefreshType.blur)break;const a=e.payload,i=a.error,o=a.validateRequired,n=t.inputStates[a.name];if(!n)throw s(a.name);if(n.value=n._refreshValue,i&&!Array.isArray(i))throw new Error("error must be array");n.error=i,n.validateRequired=o??n.validateRequired,r(n);break}case exports.ActionType.SUBMIT_STARTED:{const r=e.payload;t.formState.loading=!0,t.formState.confirmActive=r.confirmActive,t.formState.submitAttemptNumber++;break}case exports.ActionType.SUBMIT_SUCCEED:t.formState.confirmActive=!1,t.formState.loading=!1,Object.values(t.inputStates).forEach((t=>{t.validateRequired=!1})),t.formState.formStatus="SUCCESS";break;case exports.ActionType.SUBMIT_ERROR:{const r=e.payload;t.formState.confirmActive=!1,t.formState.loading=!1,Object.values(t.inputStates).forEach((t=>{t.validateRequired=!1})),t.formState.formStatus="ERROR";const a=r.error;if(a)if(Array.isArray(a))a.forEach((e=>{if(e instanceof Error||!e.name)t.formState.error=e;else{const r=t.inputStates[e.name];r&&(r.error=Array.isArray(e)?e:[e])}}));else if(a instanceof Error||!a.name)t.formState.error=a;else{const e=t.inputStates[a.name];e&&(e.error=[a])}else console.warn("Wrong usage, error must be filled if success is false");break}case exports.ActionType.ASYNC_VALIDATION:{const r=e.payload,a=t.inputStates[r.name];if(!a)throw s(r.name);r.forSubmit&&(t.formState.loading=r.value),a.validateLoading=r.value;break}default:throw new Error("Unexpected Action Type")}return t}class n{state;reducer;listeners=[];instantListeners=[];debounce;__inputValidationFunctions__={};__lastEvent__={actionProps:{type:exports.ActionType.INIT,payload:void 0},index:0};constructor(t,e){this.state=t,this.reducer=e,this.debounce=t.formState.debounceNumber&&t.formState.debounceNumber>0?new i(t.formState.debounceNumber):void 0}subscribe(t){return this.listeners.push(t),()=>{this.listeners.splice(this.listeners.indexOf(t),1)}}subscribeInstant(t){return this.instantListeners.push(t),()=>{this.listeners.splice(this.instantListeners.indexOf(t),1)}}dispatch(t){this.__lastEvent__={actionProps:{type:t.type,payload:t.payload},index:this.__lastEvent__.index+1},(t.type===exports.ActionType.NEW_VALUE&&this.state.formState.refreshType===exports.FormRefreshType.instant||t.type===exports.ActionType.BLURRED&&this.state.formState.refreshType===exports.FormRefreshType.blur)&&this.state.formState.debounceNumber&&this.state.formState.debounceNumber>0?(console.log("debounce",t,this.state.formState.refreshType),this.debounce?.cb((()=>{t.type===exports.ActionType.BLURRED?this.dispatch({type:exports.ActionType.NEW_VALUE_DEBOUNCED,payload:t.payload}):this.dispatch({type:exports.ActionType.BLURRED_DEBOUNCED,payload:t.payload})}))):(this.state=this.reducer(this.state,t),this.instantBroadcast(),this.broadcast())}getValidationData(){return Object.entries(this.state.inputStates).filter((([,t])=>t.validateRequired)).reduce(((t,[e,r])=>(t[e]=r.value,t)),{})}createInput(t,e){if(this.state.inputStates[t])return this.state.inputStates[t];this.state.inputStates[t]={name:t,value:e.defaultValue,validateLoading:!1,_refreshValue:e.defaultValue,validateRequired:!0,error:void 0}}broadcast(){this.listeners.forEach((t=>t(this.state)))}instantBroadcast(){this.instantListeners.forEach((t=>t(this.state)))}getRawData(){return Object.entries(this.state.inputStates).reduce(((t,[e,r])=>(t[e]=r.value,t)),{})}getShouldValidateAgain(){return Object.values(this.state.inputStates).reduce(((t,e)=>t||e.validateRequired),!1)}addValidation(t,e){this.__inputValidationFunctions__[t]=e||void 0}}const u=/^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/im,l=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,c=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&/=]*)/;function d(t){return!!t}function p(t,e){if(!t)return!0;let r=Number(t);return!isNaN(r)&&r>e}function h(t,e){return!t||"string"==typeof t&&t.length>e}function f(t,e){if(!t)return!0;let r=Number(t);return!isNaN(r)&&r<e}function m(t,e){return!t||"string"==typeof t&&t.length<e}function y(t){return!t||"string"==typeof t&&!!t.toLowerCase().match(l)}function S(t){return!t||"string"==typeof t&&!!t.match(u)}function E(t,e){return!e||t===e}function v(t){return!t||"string"==typeof t&&!!t.match(c)}function T(t,e){return!t||"string"==typeof t&&e.test(t)}var _;!function(t){t.required="required",t.min="min",t.minLength="minLength",t.max="max",t.maxLength="maxLength",t.email="email",t.phone="phone",t.repeatPassword="repeatPassword",t.url="url",t.regex="regex"}(_||(_={}));class A{store;validateName;validations={};settings={validateAll:!1};constructor(t,e){this.store=t,this.validateName=e}required(){return this.register(_.required,d)}min(t){return this.register(_.min,p,t)}minLength(t){return this.register(_.minLength,h,t)}max(t){return this.register(_.max,f,t)}maxLength(t){return this.register(_.maxLength,m,t)}email(){return this.register(_.email,y)}phone(){return this.register(_.phone,S)}repeatPassword(t){const e=this.store.getRawData();return this.register(_.repeatPassword,E,e?e[t]:void 0)}url(){return this.register(_.url,v)}regex(t){return this.register(_.regex,T,t)}validate(t,e,r){return this.register("custom_"+this.validateName,e,Number(r))}async(t,e,r){return this.registerAsync(t,e,r)}set(t){return this.settings={...this.settings,validateAll:t.validateAll},this}register(t,e,r){return this.validations[t]={fn:e,payload:r,async:!1},this}registerAsync(t,e,r){return this.validations[t]={fn:e,payload:r,async:!0},this}}const b=a.createContext(null);exports.FormBase=class{confirm=null;store;constructor({refreshType:t=exports.FormRefreshType.blur,shouldValidate:e=exports.FormShouldValidateType.AFTER_FIRST_SUBMIT_ATTEMPT,debounceNumber:r}){this.store=new n({formState:{formStatus:"CLEAN",confirmActive:!1,error:null,loading:!1,debounceNumber:r,refreshType:t,shouldValidate:e,submitAttemptNumber:0},inputStates:{}},o),this.onSubmit=this.onSubmit.bind(this)}getDataWithoutValidation(){const t=this.store.getRawData();return{isValid:void 0,validateErrors:void 0,shouldValidateAgain:this.store.getShouldValidateAgain(),loading:this.store.state.formState.loading,data:t}}async getDataWithValidation(t,{validateLoading:e}){const r=this.store.getRawData(),a={isValid:void 0,validateErrors:void 0,shouldValidateAgain:this.store.getShouldValidateAgain(),loading:this.store.state.formState.loading,data:r};if(t){const t=await this.validate(r,{validateLoading:e});a.isValid=!(t&&t.length),a.validateErrors=t}return a}async onSubmit(t){const e=this.store.state,r=e.formState;Object.values(e.inputStates).forEach((t=>{t.value=t._refreshValue})),r.loading&&console.warn("Double click detect"),r.confirmActive&&console.warn("Form submitted when confirm active"),this.store.dispatch({type:exports.ActionType.SUBMIT_STARTED,payload:{confirmActive:!0}});const a=await this.getDataWithValidation(!0,{validateLoading:!0});if(a.isValid)try{const e=t=>{this.confirm=(e,r)=>{if(e){const e=t(r);this.onSubmitResult(e)}else this.store.dispatch({type:exports.ActionType.SUBMIT_ERROR,payload:{payload:{error:r}}})}},s=t&&t(a,{confirm:e});if(r.confirmActive)return;this.onSubmitResult(s)}catch(t){this.store.dispatch({type:exports.ActionType.SUBMIT_ERROR,payload:{payload:{error:t}}})}else{const t=[];if(a.validateErrors){for(let e=0;e<a.validateErrors.length;e++){const r=a.validateErrors[e];t.push({value:r.value,name:r.name,payload:r.payload,type:r.type})}this.store.dispatch({type:exports.ActionType.SUBMIT_ERROR,payload:{error:t}})}}}shouldValidate(t){const e=this.store.state.formState.shouldValidate;let r=!1;if("function"==typeof e)r=e(this);else{const a=e;(a===exports.FormShouldValidateType.YES||a===exports.FormShouldValidateType.AFTER_FIRST_SUBMIT_ATTEMPT&&t.submitAttemptNumber>0)&&(r=!0)}return r}createInput(t,e){return this.store.createInput(t,e),e.validation?this.store.__inputValidationFunctions__[t]=e.validation:this.store.__inputValidationFunctions__[t]=void 0,{onChange:e=>{this.setValue(t,e).then()},onBlur:async()=>{console.log("this.store.state.formState.refreshType",this.store.state.formState.refreshType),this.store.state.formState.refreshType===exports.FormRefreshType.blur&&setTimeout((async()=>{let e;const r=this.store.state.inputStates[t],a=r?._refreshValue;r?.validateRequired&&(e=await this.validateInput(t,a)),this.store.dispatch({type:exports.ActionType.BLURRED,payload:{name:t,error:e,validateRequired:void 0===e}})}),50)},addValidation:e=>{this.store.addValidation(t,e)}}}deleteInput(t){this.checkNameExist(t),delete this.store.state.inputStates[t]}async setValue(t,e){this.checkNameExist(t);let r=null,a=!1;this.store.state.formState.refreshType===exports.FormRefreshType.instant&&(r=await this.validateInput(t,e),a=!0),this.store.dispatch({type:exports.ActionType.NEW_VALUE,payload:{value:e,name:t,error:r,validateRequired:!a}})}async validateInput(t,e){this.checkNameExist(t);const r=this.store.state.formState,a=this.store.__inputValidationFunctions__[t];if(!a)return null;if(!this.shouldValidate(r))return;const s=a(new A(this.store,"validator_"+t));if(!s)return null;let i=[];const o=Object.keys(s.validations);for(let r=0;r<o.length;r++){if(i.length&&!s.settings.validateAll)return i;const a=o[r],n=s.validations[a],u=n.fn(e,n.payload);if(u||i.push([{name:t,type:a,value:e,payload:n.payload}]),u&&u.then){this.store.dispatch({type:exports.ActionType.ASYNC_VALIDATION,payload:{name:t,value:!0,forSubmit:!1}});const r=await u;this.store.dispatch({type:exports.ActionType.ASYNC_VALIDATION,payload:{name:t,value:!1,forSubmit:!1}}),r||i.push({name:t,type:a,value:e,payload:n.payload})}}return i}async validate(t,{validateLoading:e}){const r=[],a=Object.keys(t);for(let s=0;s<a.length;s++){const i=a[s],o=this.store.__inputValidationFunctions__[i];if(!o)continue;const n=o(new A(this.store,"validator_"+i));if(!n)continue;const u=Object.keys(n.validations);for(let a=0;a<u.length;a++){const s=u[a],o=n.validations[s],l=t[i],c=o.fn(l,o.payload);if(c||r.push({name:i,type:s,value:l,payload:o.payload}),c&&c.then){e&&this.store.dispatch({type:exports.ActionType.ASYNC_VALIDATION,payload:{name:i,value:!0,forSubmit:!0}});const t=await c;e&&this.store.dispatch({type:exports.ActionType.ASYNC_VALIDATION,payload:{name:i,value:!1,forSubmit:!0}}),t||r.push({name:i,type:s,value:l,payload:o.payload})}}}return r}checkNameExist(t){if(!this.store.state.inputStates[t])throw s(t)}onSubmitResult(t){if(t&&void 0!==t.then){t.then((()=>{this.store.dispatch({type:exports.ActionType.SUBMIT_SUCCEED})})).catch((t=>{this.store.dispatch({type:exports.ActionType.SUBMIT_ERROR,payload:{error:t}})}))}else this.store.dispatch({type:exports.ActionType.SUBMIT_SUCCEED})}},exports.Validator=A,exports.getErrorDefaultText=function(t){switch(console.log("error",t),t.type){case _.required:return"This Field is required.";case _.min:return"Minimum required number is "+t.payload;case _.minLength:return"Minimum "+t.payload+" "+(1===t.payload?"character":"characters")+" are allowed";case _.max:return"Maximum required number is "+t.payload;case _.maxLength:return"Maximum "+t.payload+" "+(1===t.payload?"character":"characters")+" are allowed";case _.email:return"Please enter a valid email address.";case _.phone:return"Please enter a valid phone number.";case _.repeatPassword:return(t&&t.name?t.name:"Password ")+" is not matched.";case _.url:return"Please enter a valid url."}return t.payload?.message||"Invalid field"},exports.useConfirm=function(t){const[e,r]=a.useState((()=>t.store.state.formState.confirmActive)),s=a.useCallback((e=>{t.confirm&&t.confirm(!0,e)}),[t]),i=a.useCallback((()=>{t.confirm&&t.confirm(!1)}),[t]);return a.useEffect((()=>t.store.subscribe((e=>{r(t.store.state.formState.confirmActive)}))),[t]),{active:e,resolve:s,reject:i}},exports.useContextFormBase=function(){const t=a.useContext(b);if(!t)throw new Error(`You cannot use ${"useContextFormBase"} outside of Form Component`);return t.formBase},exports.useCreateInput=function(t,e,r={}){const s=t.createInput(e,{defaultValue:r.defaultValue,validation:r.validation});return a.useInsertionEffect((()=>()=>t.deleteInput(e)),[t,e]),s},exports.useErrorForGlobal=function(t){const[e,r]=a.useState((()=>t.store.state.formState?.error));return a.useEffect((()=>{r(t.store.state.formState?.error)}),[t]),a.useEffect((()=>t.store.subscribe((()=>{const e=t.store.state.formState;r(e?.error)}))),[t]),e},exports.useErrorForInput=function(t,e){const[r,s]=a.useState((()=>t.store.state.inputStates[e]?.error)),[i,o]=a.useState((()=>t.store.state.inputStates[e]?.validateLoading));return a.useEffect((()=>{const r=t.store.state.inputStates[e];s(r?.error),o(r?.validateLoading)}),[t,e]),a.useEffect((()=>t.store.subscribe((()=>{const r=t.store.state.inputStates[e];s(r?.error),o(r?.validateLoading)}))),[t,e]),{error:r&&r[0],loading:i}},exports.useEventChange=function(t){const[e,r]=a.useState((()=>[{...t.store.__lastEvent__}]));return a.useEffect((()=>t.store.subscribe((()=>{const e=t.store.__lastEvent__;r((t=>[...t,{...e}]))}))),[t]),[e,r]},exports.useInstantWatch=function(t,e){const[r,s]=a.useState((()=>e?t.store.state.inputStates[e]?._refreshValue:void 0));return a.useEffect((()=>{e&&s(t.store.state.inputStates[e]?._refreshValue)}),[t,e]),a.useEffect((()=>{if(!e)return;return t.store.subscribeInstant((t=>{s(t.inputStates[e]?._refreshValue)}))}),[t,e]),r},exports.useLoading=function(t){const[e,r]=a.useState((()=>t.store.state.formState?.loading));return a.useEffect((()=>{r(t.store.state.formState?.loading)}),[t]),a.useEffect((()=>t.store.subscribe((t=>{r(t.formState.loading)}))),[t]),e},exports.useResponseDataWatch=function(t){const[e,r]=a.useState((()=>t.getDataWithoutValidation())),s=a.useRef(0);return a.useEffect((()=>{const e=t.store;return e.subscribe((async()=>{const a=e.state.formState;if("NOT-CLEAN"!==a.formStatus)return;const i=a.submitAttemptNumber,o=await t.getDataWithValidation(s.current!==i,{validateLoading:!1});s.current!==i&&(s.current=i),r(o)}))}),[t]),e},exports.useStoreStateWatch=function(t,e){const[r,s]=a.useState((()=>t.store.state));return a.useEffect((()=>{const r=t=>{s({...t})};return"instant"===e?t.store.subscribeInstant(r):t.store.subscribe(r)}),[e,t]),r},exports.useWatch=function(t,e){const[r,s]=a.useState((()=>e?t.store.state.inputStates[e]?.value:void 0));return a.useEffect((()=>{e&&s(t.store.state.inputStates[e]?.value)}),[t,e]),a.useEffect((()=>{if(!e)return;return t.store.subscribe((t=>{s(t.inputStates[e]?.value)}))}),[t,e]),r};
//# sourceMappingURL=index.cjs.js.map
